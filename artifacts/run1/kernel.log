mkdir -p build
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/arch/riscv/boot.S -o build/boot.o
Generating include/user_progs.h
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/kernel.c -o build/kernel.o
src/kernel/kernel.c:221:13: warning: 'thread_kernel_yielder' defined but not used [-Wunused-function]
  221 | static void thread_kernel_yielder(void) {
      |             ^~~~~~~~~~~~~~~~~~~~~
src/kernel/kernel.c:205:13: warning: 'thread_kalloc_stress' defined but not used [-Wunused-function]
  205 | static void thread_kalloc_stress(void) {
      |             ^~~~~~~~~~~~~~~~~~~~
src/kernel/kernel.c:187:13: warning: 'thread_trace_printer' defined but not used [-Wunused-function]
  187 | static void thread_trace_printer(void) {
      |             ^~~~~~~~~~~~~~~~~~~~
src/kernel/kernel.c:172:13: warning: 'stress_test_threads' defined but not used [-Wunused-function]
  172 | static void stress_test_threads() {
      |             ^~~~~~~~~~~~~~~~~~~
src/kernel/kernel.c:33:13: warning: 'thread_ecall_test' defined but not used [-Wunused-function]
   33 | static void thread_ecall_test(void) {
      |             ^~~~~~~~~~~~~~~~~
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/drivers/uart.c -o build/uart.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/panic.c -o build/panic.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/printf.c -o build/printf.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/arch/riscv/ktrap.S -o build/ktrap.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/trap.c -o build/trap.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/arch/riscv/mtrap.S -o build/mtrap.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/timer.c -o build/timer.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/clock.c -o build/clock.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/sched.c -o build/sched.o
src/kernel/sched.c: In function 'yield_from_trap':
src/kernel/sched.c:610:9: warning: unused variable 'restore' [-Wunused-variable]
  610 |     int restore = (r_sstatus() & SSTATUS_SPIE) != 0;
      |         ^~~~~~~
At top level:
src/kernel/sched.c:495:13: warning: 'user_trampoline' defined but not used [-Wunused-function]
  495 | static void user_trampoline() {
      |             ^~~~~~~~~~~~~~~
src/kernel/sched.c:84:13: warning: 'fmt_pid' defined but not used [-Wunused-function]
   84 | static void fmt_pid(char * out, int16_t id, uint8_t is_user) {
      |             ^~~~~~~
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/kalloc.c -o build/kalloc.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/vm.c -o build/vm.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/arch/riscv/swtch.S -o build/swtch.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/syscall.c -o build/syscall.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/metrics.c -o build/metrics.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/arch/riscv/kernelvec.S -o build/kernelvec.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/arch/riscv/trampoline.S -o build/trampoline.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/file.c -o build/file.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/drivers/virtio_blk.c -o build/virtio_blk.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/buf.c -o build/buf.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/fs.c -o build/fs.o
src/kernel/fs.c: In function 'itrunc':
src/kernel/fs.c:332:27: warning: comparison of integer expressions of different signedness: 'int' and 'long unsigned int' [-Wsign-compare]
  332 |         for (int i = 0; i < NINDIRECT; i++) {
      |                           ^
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/btree.c -o build/btree.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/extent.c -o build/extent.o
src/kernel/extent.c:275:12: warning: 'extent_tree_add' defined but not used [-Wunused-function]
  275 | static int extent_tree_add(uint32_t root, uint32_t start, uint32_t len,
      |            ^~~~~~~~~~~~~~~
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/tree.c -o build/tree.o
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c src/kernel/fs_tree.c -o build/fs_tree.o
riscv64-unknown-elf-gcc -nostdlib -nostartfiles -ffreestanding \
  -march=rv64imac -mabi=lp64 \
  -Wl,-Ttext=0x10000 -Wl,-e,_start \
  -o build/userA.elf src/user/testA.S
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c build/userA_blob.c -o build/userA_blob.o
riscv64-unknown-elf-gcc -nostdlib -nostartfiles -ffreestanding \
  -march=rv64imac -mabi=lp64 \
  -Wl,-Ttext=0x10000 -Wl,-e,_start \
  -o build/userB.elf src/user/testB.S
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c build/userB_blob.c -o build/userB_blob.o
riscv64-unknown-elf-gcc -nostdlib -nostartfiles -ffreestanding \
  -march=rv64imac -mabi=lp64 \
  -Wl,-Ttext=0x10000 -Wl,-e,_start \
  -o build/userC.elf src/user/testC.S
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c build/userC_blob.c -o build/userC_blob.o
riscv64-unknown-elf-gcc -nostdlib -nostartfiles -ffreestanding \
  -march=rv64imac -mabi=lp64 \
  -Wl,-Ttext=0x10000 -Wl,-e,_start \
  -o build/userD.elf src/user/testD.S
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c build/userD_blob.c -o build/userD_blob.o
riscv64-unknown-elf-gcc -nostdlib -nostartfiles -ffreestanding \
  -march=rv64imac -mabi=lp64 \
  -Wl,-Ttext=0x10000 -Wl,-e,_start \
  -o build/userE.elf src/user/testE.S
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c build/userE_blob.c -o build/userE_blob.o
riscv64-unknown-elf-gcc -nostdlib -nostartfiles -ffreestanding \
  -march=rv64imac -mabi=lp64 \
  -Wl,-Ttext=0x10000 -Wl,-e,_start \
  -Iinclude \
  -o build/userF.elf src/user/crt0.S src/user/testF.c
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c build/userF_blob.c -o build/userF_blob.o
riscv64-unknown-elf-gcc -nostdlib -nostartfiles -ffreestanding \
  -march=rv64imac -mabi=lp64 \
  -Wl,-Ttext=0x10000 -Wl,-e,_start \
  -Iinclude \
  -o build/userInit.elf src/user/crt0.S src/user/init.c
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c build/userInit_blob.c -o build/userInit_blob.o
riscv64-unknown-elf-gcc -nostdlib -nostartfiles -ffreestanding \
  -march=rv64imac -mabi=lp64 \
  -Wl,-Ttext=0x10000 -Wl,-e,_start \
  -Iinclude \
  -o build/userW.elf src/user/crt0.S src/user/run_workload.c
riscv64-unknown-elf-gcc -g -Wall -Wextra -ffreestanding -nostdlib -nostartfiles -march=rv64imac -mabi=lp64 -mcmodel=medany -Iinclude -c build/userW_blob.c -o build/userW_blob.o
riscv64-unknown-elf-ld -T linker.ld -nostdlib -o kernel.elf build/boot.o build/kernel.o build/uart.o build/panic.o build/printf.o build/ktrap.o build/trap.o build/mtrap.o build/timer.o build/clock.o build/sched.o build/kalloc.o build/vm.o build/swtch.o build/syscall.o build/metrics.o build/kernelvec.o build/trampoline.o build/file.o build/virtio_blk.o build/buf.o build/fs.o build/btree.o build/extent.o build/tree.o build/fs_tree.o build/userA_blob.o build/userB_blob.o build/userC_blob.o build/userD_blob.o build/userE_blob.o build/userF_blob.o build/userInit_blob.o build/userW_blob.o
cp disk.img build/disk_run.img
qemu-system-riscv64 \
  -machine virt \
  -smp 1 \
  -bios none \
  -kernel kernel.elf \
  -drive file=build/disk_run.img,if=none,format=raw,id=hd0 \
  -device virtio-blk-device,drive=hd0 \
  -nographic
va 0x0000000080000000: pte=0x000000002000004b pa=0x0000000080000000 flags=0x000000000000004b
va 0x0000000080015000: pte=0x0000000020005443 pa=0x0000000080015000 flags=0x0000000000000043
va 0x0000000080017000: pte=0x0000000020005cc7 pa=0x0000000080017000 flags=0x00000000000000c7
va 0x0000000010000000: pte=0x00000000040000c7 pa=0x0000000010000000 flags=0x00000000000000c7
va 0x0000000000000000: no pte
virtio: found block device at 0x0000000010008000
virtio: MMIO version 1
virtio: found block device
virtio: device features: 0x0000000031006ed4
virtio: max queue size = 1024, using 8
virtio: block device initialized
buf: cache initialized with 30 buffers
fs: mounted (v1, 16384 blocks, 1638 inodes)
tiny-os booted
fs: testing filesystem...
fs: TEST 1 - Creating /mydir...
fs: OK - created /mydir (inum=2)
fs: TEST 2 - Creating /mydir/hello.txt...
fs: OK - created /mydir/hello.txt with 'Hello from subdirectory!'
fs: TEST 3 - Reading /mydir/hello.txt...
fs: OK - read: 'Hello from subdirectory!'
fs: TEST 4 - Creating /mydir/subdir...
fs: OK - created /mydir/subdir (inum=4)
fs: TEST 5 - Creating /mydir/subdir/deep.txt...
fs: OK - created deep.txt
fs: Verified: 'Deep nested file!'
fs: Filesystem tests complete!
btree: testing btree...
btree: OK
btree: testing persistence...
btree: persisted root=135
extent: testing extent allocator...
extent: OK (alloc 137 len 8)
tree: testing root tree...
tree: OK (extent=136 fs=16383)
fs_tree: testing fs tree...
fs_tree_file_write: ino=100 off=0 n=13 size=0
fs_tree_file_write: alloc blocks=1 pos=0
fs_tree_file_write: ino=100 off=2048 n=14 size=13
fs_tree_file_write: alloc blocks=1 pos=2048
fs_tree_create_file: path='/rename_a'
fs_tree_create_file: ok ino=2 name='rename_a'
fs_tree_create_file: path='/a'
fs_tree_create_file: ok ino=4 name='a'
fs_tree_create_file: path='/b'
fs_tree_create_file: ok ino=5 name='b'
fs_tree: OK
fs_tree_create_file: path='/bin/testC'
fs_tree_create_file: ok ino=7 name='testC'
fs_tree_file_write: ino=7 off=0 n=5984 size=0
fs_tree_file_write: alloc blocks=6 pos=0
fs_tree_create_file: path='/bin/testD'
fs_tree_create_file: ok ino=8 name='testD'
fs_tree_file_write: ino=8 off=0 n=6144 size=0
fs_tree_file_write: alloc blocks=6 pos=0
fs_tree_create_file: path='/bin/testE'
fs_tree_create_file: ok ino=9 name='testE'
fs_tree_file_write: ino=9 off=0 n=7592 size=0
fs_tree_file_write: alloc blocks=8 pos=0
fs_tree_create_file: path='/bin/testF'
fs_tree_create_file: ok ino=10 name='testF'
fs_tree_file_write: ino=10 off=0 n=8240 size=0
fs_tree_file_write: alloc blocks=9 pos=0
fs_tree_create_file: path='/bin/run_workload'
fs_tree_create_file: ok ino=11 name='run_workload'
fs_tree_file_write: ino=11 off=0 n=7192 size=0
fs_tree_file_write: alloc blocks=8 pos=0
spawned init user proc (ELF) len=12144
firstrun: pid=0 epc=0x0000000000010000 sp=0x0000003fffffe000
sys_exec: pid=0 path='/bin/run_workload'
proc_exec: pid=0 entry=0x0000000000010000 sz=7192
sys_exec: proc_exec r=0
READY
METRICS_BEGIN
{
  "version": 1,
  "ticks": 35,
  "syscall_enter": 4,
  "syscall_exit": 0,
  "ctx_switches": 11,
  "page_faults": 0,
  "disk_reads": 852,
  "disk_writes": 4868,
  "disk_read_bytes": 436224,
  "disk_write_bytes": 2492416
}
METRICS_END
DONE 0
